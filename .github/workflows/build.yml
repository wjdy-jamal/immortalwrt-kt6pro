name: Build ImmortalWrt for KT-6 Pro

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # Ø¨Ù†Ø§Ø¡ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙƒÙ„ Ø£Ø­Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹

env:
  BUILD_THREADS: 4
  CCACHE_SIZE: 10G

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 300  # 5 Ø³Ø§Ø¹Ø§Øª

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        submodules: recursive
        path: source

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          rsync subversion swig time xsltproc zlib1g-dev unzip wget curl \
          python-is-python3 gcc-multilib g++-multilib ncurses-dev zlib1g-dev \
          libbz2-dev libssl-dev liblzma-dev libc6-dev-i386 autoconf automake \
          libtool-bin python3-pip libtinfo5 upx-ucl

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.ref }}
        max-size: ${{ env.CCACHE_SIZE }}

    - name: Clone ImmortalWrt
      run: |
        git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git -b v23.05.3
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… ØªÙ… Ø§Ø³ØªÙ†Ø³Ø§Ø® ImmortalWrt"

    - name: Apply KT-6 Pro Configuration
      run: |
        # Ù†Ø³Ø® Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„
        cp source/configs/kt6pro.config immortalwrt/.config
        
        # Ù†Ø³Ø® Ù…Ù„Ù DTS Ø§Ù„Ù…Ø®ØµØµ
        mkdir -p immortalwrt/target/linux/qualcommax/files-5.15/arch/arm64/boot/dts/qcom/
        cp source/dts/ipq5018-kt6pro.dts immortalwrt/target/linux/qualcommax/files-5.15/arch/arm64/boot/dts/qcom/
        
        # Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ®ØµÙŠØµ
        cp -r source/files/* immortalwrt/files/
        
        cd immortalwrt
        make defconfig

    - name: Build Information
      run: |
        echo "ğŸ”¨ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ ImmortalWrt Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù€ KT-6 Pro"
        echo "ğŸ”„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ImmortalWrt 23.05.3"
        echo "ğŸ“± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬: Qualcomm IPQ5018 (Dual-core Cortex-A53)"
        echo "ğŸ”Œ Ø§Ù„Ø³ÙˆÙŠØªØ´: QCA8337 (3 LAN + 1 WAN)"
        echo "ğŸ“¶ Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ: Qualcomm ath11k (WiFi 6 AX3000)"
        echo "ğŸ“± Ø§Ù„Ù…ÙˆØ¯Ù…: 5G Ù…Ø¯Ù…Ø¬"
        echo "âš¡ MWAN3: Ø¯Ø¹Ù… Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø±Ø¹Ø§Øª"
        echo "ğŸ• ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡: $(date)"
        echo "â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: 2-3 Ø³Ø§Ø¹Ø§Øª"

    - name: Build Firmware
      run: |
        cd immortalwrt
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡..."
        echo "ğŸ“Š Ø§Ø³ØªØ®Ø¯Ø§Ù… $BUILD_THREADS Ø£Ù†ÙˆÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"
        make -j${{ env.BUILD_THREADS }} V=s 2>&1 | tee build.log

    - name: Check Build Results
      run: |
        cd immortalwrt
        if [ -f bin/targets/qualcommax/ipq50xx/*.bin ]; then
          echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¬Ø­!"
          ls -lh bin/targets/qualcommax/ipq50xx/*.bin
        else
          echo "âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡"
          exit 1
        fi

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: firmware-kt6pro
        path: |
          immortalwrt/bin/targets/qualcommax/ipq50xx/*.bin
          immortalwrt/bin/targets/qualcommax/ipq50xx/*.manifest
        retention-days: 30

    - name: Upload Build Log
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: |
          immortalwrt/build.log
        retention-days: 90

    - name: Completion Message
      run: |
        echo "ğŸ‰ ØªÙ… Ø§ÙƒØªÙ…Ø§Ù„ Ø¨Ù†Ø§Ø¡ ImmortalWrt Ù„Ù€ KT-6 Pro!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ù‚Ø³Ù… Artifacts"
        echo "ğŸ• ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: $(date)"
